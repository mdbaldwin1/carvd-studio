name: Website Version Bump

on:
  push:
    branches: [main]
    paths:
      - 'packages/website/**'

jobs:
  bump:
    name: Bump Website Version on Develop
    # Skip version-bump commits to prevent infinite loops
    if: "!contains(github.event.head_commit.message, 'chore(website):')"
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      statuses: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check if website version changed
        id: check
        run: |
          CURRENT=$(node -p "require('./packages/website/package.json').version")

          # Compare against the latest website-v* tag instead of HEAD~1
          # This is squash-merge safe since tags are durable artifacts
          LATEST_TAG=$(git tag --list 'website-v*' --sort=-version:refname | head -n 1)
          PREV="${LATEST_TAG#website-v}"

          echo "Current: $CURRENT"
          echo "Latest website tag: ${LATEST_TAG:-<none>} (version: ${PREV:-<none>})"

          if [ -z "$PREV" ]; then
            echo "âœ… No previous website tag found - proceeding with bump"
            echo "should_bump=true" >> $GITHUB_OUTPUT
            echo "version=$CURRENT" >> $GITHUB_OUTPUT
          elif [ "$CURRENT" = "$PREV" ]; then
            echo "â­ï¸  Website version $CURRENT matches latest tag - skipping"
            echo "should_bump=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Website version changed: $PREV -> $CURRENT"
            echo "should_bump=true" >> $GITHUB_OUTPUT
            echo "version=$CURRENT" >> $GITHUB_OUTPUT
          fi

      - name: Wait for Vercel deployment
        if: steps.check.outputs.should_bump == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          SHA="${{ github.sha }}"
          echo "Waiting for Vercel deployment to complete for $SHA..."

          MAX_ATTEMPTS=60  # 10 minutes (60 * 10s)
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            STATE=$(gh api "repos/${{ github.repository }}/commits/$SHA/status" \
              --jq '.statuses[] | select(.context == "Vercel") | .state' 2>/dev/null || echo "")

            if [ "$STATE" = "success" ]; then
              echo "âœ… Vercel deployment succeeded"
              break
            elif [ "$STATE" = "failure" ] || [ "$STATE" = "error" ]; then
              echo "âŒ Vercel deployment failed (state: $STATE)"
              exit 1
            fi

            ATTEMPT=$((ATTEMPT + 1))
            echo "â³ Vercel status: ${STATE:-pending} (attempt $ATTEMPT/$MAX_ATTEMPTS)"
            sleep 10
          done

          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "â° Timed out waiting for Vercel deployment"
            exit 1
          fi

      - name: Create website version tag
        if: steps.check.outputs.should_bump == 'true'
        run: |
          VERSION="${{ steps.check.outputs.version }}"
          TAG="website-v${VERSION}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git rev-parse "$TAG" &>/dev/null; then
            echo "Tag $TAG already exists - reusing"
          else
            git tag "$TAG"
            git push origin "$TAG"
            echo "âœ… Created tag $TAG"
          fi

      - name: Compute next patch version
        if: steps.check.outputs.should_bump == 'true'
        id: next
        run: |
          CURRENT="${{ steps.check.outputs.version }}"
          IFS='.' read -ra PARTS <<< "$CURRENT"
          NEXT="${PARTS[0]}.${PARTS[1]}.$((PARTS[2] + 1))"
          echo "version=$NEXT" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Next website version: $NEXT"

      - name: Checkout develop branch
        if: steps.check.outputs.should_bump == 'true'
        uses: actions/checkout@v6
        with:
          ref: develop
          fetch-depth: 0

      - name: Create version bump branch and PR
        if: steps.check.outputs.should_bump == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          NEXT="${{ steps.next.outputs.version }}"
          BRANCH="chore/bump-website-version-to-${NEXT}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH"

          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('packages/website/package.json', 'utf-8'));
            pkg.version = '${NEXT}';
            fs.writeFileSync('packages/website/package.json', JSON.stringify(pkg, null, 4) + '\n');
          "

          git add packages/website/package.json
          git commit -m "chore(website): bump website version to ${NEXT}"

          git push origin "$BRANCH"

          gh pr create \
            --base develop \
            --head "$BRANCH" \
            --title "chore: bump website version to ${NEXT}" \
            --body "Automated website version bump after deployment of v${{ steps.check.outputs.version }}. Merge when ready to start the next development cycle."

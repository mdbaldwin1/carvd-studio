name: Sync Develop

on:
  workflow_run:
    workflows: ['Release']
    types: [completed]
  workflow_dispatch: {}

concurrency:
  group: sync-develop
  cancel-in-progress: true

jobs:
  sync:
    name: Sync Main to Develop
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout develop branch
        uses: actions/checkout@v6
        with:
          ref: develop
          fetch-depth: 0

      - name: Merge main into develop and create PR
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_PAT }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main develop

          # Check if there are commits in main that aren't in develop
          if ! git log origin/develop..origin/main --oneline | grep -q .; then
            echo "⏭️  develop is already up to date with main — nothing to do"
            exit 0
          fi

          # Reuse an existing open sync PR branch when possible to avoid PR churn
          EXISTING_BRANCH=$(gh pr list \
            --base develop \
            --state open \
            --json title,headRefName \
            --jq '.[] | select(.title=="chore: sync main back to develop") | .headRefName' \
            | head -n 1)

          if [ -n "$EXISTING_BRANCH" ]; then
            BRANCH="$EXISTING_BRANCH"
            git checkout -B "$BRANCH" "origin/$BRANCH"
          else
            BRANCH="chore/sync-main-to-develop-$(date +%Y%m%d-%H%M%S)"
            git checkout -b "$BRANCH"
          fi

          git merge origin/main --no-edit -m "chore: sync main back to develop"

          # If the sync branch no longer differs from develop, close stale PR and exit
          if ! git log origin/develop..HEAD --oneline | grep -q .; then
            echo "⏭️  Sync branch has no changes vs develop"
            if [ -n "$EXISTING_BRANCH" ]; then
              PR_NUMBER=$(gh pr list \
                --base develop \
                --head "$EXISTING_BRANCH" \
                --state open \
                --json number \
                --jq '.[0].number // empty')
              if [ -n "$PR_NUMBER" ]; then
                gh pr close "$PR_NUMBER" --comment "Closing as redundant: no remaining diff vs develop."
              fi
            fi
            exit 0
          fi

          git push origin "$BRANCH"

          if [ -z "$EXISTING_BRANCH" ]; then
            gh pr create \
              --base develop \
              --head "$BRANCH" \
              --title "chore: sync main back to develop" \
              --body "Automated sync of main back to develop after release completes."
          else
            echo "✅ Updated existing sync PR branch: $BRANCH"
          fi
